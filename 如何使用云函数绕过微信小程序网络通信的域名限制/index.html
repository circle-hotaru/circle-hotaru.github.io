<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="&lt;% config.title %&gt;"><meta name="twitter:creator" content="@circlehotarux"><meta name="twitter:title" content="&lt;% page.title %&gt; | &lt;% config.title %&gt;"><meta name="twitter:description" content="&lt;% page.description %&gt;"><meta name="twitter:image" content="&lt;% page.coverpic %&gt;"><title>如何使用云函数绕过微信小程序网络通信的域名限制 · circlehotarux's blog</title><meta name="description" content="引言在微信小程序开发过程中我们会遇到小程序只可以跟指定的域名进行网络通信。包括普通 HTTPS 请求（wx.request）、上传文件（wx.uploadFile）、下载文件（wx.downloadFile) 和 WebSocket 通信（wx.connectSocket）。域名需要满足HTTPS和"><meta name="keywords" content="Blog,博客,技術,circlehotarux,mightyherox"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 5.2.0"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">circlehotarux</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">多度橙</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/categories">分类</a></li><li><a href="/tags">标签</a></li><li><a href="/baidu_verify_2ZKRTnPntf.html"></a></li><li><a href="/about/index.html">About</a></li><li class="soc"><a href="https://github.com/circle-hotaru" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="https://twitter.com/CircleHotaru" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter">&nbsp;</i></a><a href="https://www.instagram.com/circlehotarux" target="_blank" rel="noopener noreferrer"><i class="fa fa-instagram">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://mightyherox.me" rel="noopener noreferrer">circlehotarux</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>如何使用云函数绕过微信小程序网络通信的域名限制</a></p><p class="post-meta"><span class="date meta-item">发布于&nbsp;2020-11-21</span><span class="meta-item"><i class="fa fa-comment-o"></i><span>&nbsp;</span><a href="/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E4%BA%91%E5%87%BD%E6%95%B0%E7%BB%95%E8%BF%87%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E7%9A%84%E5%9F%9F%E5%90%8D%E9%99%90%E5%88%B6/#comments">评论</a></span><span class="meta-item"><i class="fa fa-folder"></i><span>&nbsp;</span><a href="/categories/编程/" title="编程" class="a-tag">编程</a><span>&nbsp;</span></span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/微信小程序/" title="微信小程序" class="a-tag">微信小程序</a><span>&nbsp;</span><a href="/tags/云函数/" title="云函数" class="a-tag">云函数</a><span>&nbsp;</span><a href="/tags/云开发/" title="云开发" class="a-tag">云开发</a><span>&nbsp;</span><a href="/tags/Node-js/" title="Node.js" class="a-tag">Node.js</a><span>&nbsp;</span></span></p><p class="post-abstract"><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在微信小程序开发过程中我们会遇到小程序<strong>只可以跟指定的域名进行网络通信</strong>。包括普通 HTTPS 请求（<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html">wx.request</a>）、上传文件（<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/upload/wx.uploadFile.html">wx.uploadFile</a>）、下载文件（<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/download/wx.downloadFile.html">wx.downloadFile</a>) 和 WebSocket 通信（<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/websocket/wx.connectSocket.html">wx.connectSocket</a>）。域名需要满足HTTPS和备案条件。如果是自家域名，你可以按照要求去做。但如果你要访问第三方API，而它恰好不满足上述条件时该怎么办？</p>
<h2 id="使用云函数中转"><a href="#使用云函数中转" class="headerlink" title="使用云函数中转"></a>使用云函数中转</h2><p>一个比较简单的方法是使用云函数中转。将有限制的小程序请求转为没有限制的云函数请求，达到间接访问未备案、无HTTPS API的效果。</p>
<blockquote>
<p>云函数（Serverless Cloud Function，SCF）是腾讯云为企业和开发者们提供的无服务器执行环境，帮助您在无需购买和管理服务器的情况下运行代码。您只需使用平台支持的语言编写核心代码并设置代码运行的条件，即可在腾讯云基础设施上弹性、安全地运行代码。SCF 是实时文件处理和数据处理等场景下理想的计算平台。</p>
</blockquote>
<h2 id="本例使用的API"><a href="#本例使用的API" class="headerlink" title="本例使用的API"></a>本例使用的API</h2><p>假设我们要访问的API是<a target="_blank" rel="noopener" href="https://ghibliapi.herokuapp.com/">Studio Ghibli API</a>，会返回一些Ghibli电影或人物资料。</p>
<p>我们向该API地址<code>https://ghibliapi.herokuapp.com/films/2baf70d1-42bb-4437-b551-e5fed5a87abe</code>发送一个get请求，将获取到如下结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;2baf70d1-42bb-4437-b551-e5fed5a87abe&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Castle in the Sky&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;The orphan Sheeta inherited a mysterious crystal that links her to the mythical sky-kingdom of Laputa. With the help of resourceful Pazu and a rollicking band of sky pirates, she makes her way to the ruins of the once-great civilization. Sheeta and Pazu must outwit the evil Muska, who plans to use Laputa&#x27;s science to make himself ruler of the world.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;director&quot;</span>: <span class="string">&quot;Hayao Miyazaki&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;producer&quot;</span>: <span class="string">&quot;Isao Takahata&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;release_date&quot;</span>: <span class="number">1986</span>,</span><br><span class="line">  <span class="attr">&quot;rt_score&quot;</span>: <span class="number">95</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="创建云函数"><a href="#创建云函数" class="headerlink" title="创建云函数"></a>创建云函数</h2><p>首先在小程序开发者工具中点击上方的云开发按钮，开通云开发功能。第一次打开会先让你新建一个环境，选择配额方案。对于个人开发者而言免费的基础版1应该够用了。</p>
<p><img src="https://i.loli.net/2020/11/21/HTvUMrYEWiQCzx2.png" alt="2020-11-21_开通云开发.png"></p>
<p><img src="https://i.loli.net/2020/11/21/xtQse6y78Jk9bvL.png" alt="2020-11-21_配额方案.png"></p>
<p>回到微信开发者工具，在云函数根目录右键<strong>新建Node.js云函数</strong>。</p>
<p><img src="https://i.loli.net/2020/11/21/4ewZUY38nKh6fQ9.png" alt="2020-11-21_新建NodeJS云函数.png"></p>
<p>新建好的云函数目录结构如下所示，我们在该目录打开终端，执行<code>npm i</code>安装<strong>wx-server-sdk</strong>，这是云函数开发必须安装的依赖。</p>
<p><img src="https://i.loli.net/2020/11/21/M2oLVF4JkvAasBw.png" alt="2020-11-21_新建好的云函数目录.png"></p>
<p>接着执行<code>npm i -S got</code>。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/sindresorhus/got#readme">got</a>是Node.js中一个轻量级且功能强大的HTTP请求库。</p>
</blockquote>
<h2 id="编写云函数代码"><a href="#编写云函数代码" class="headerlink" title="编写云函数代码"></a>编写云函数代码</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 云函数入口文件</span></span><br><span class="line"><span class="keyword">const</span> cloud = <span class="built_in">require</span>(<span class="string">&#x27;wx-server-sdk&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> got = <span class="built_in">require</span>(<span class="string">&#x27;got&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cloud.init()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 云函数入口函数</span></span><br><span class="line"><span class="built_in">exports</span>.main = <span class="keyword">async</span> (event, context) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> got(<span class="string">&#x27;https://ghibliapi.herokuapp.com/films/2baf70d1-42bb-4437-b551-e5fed5a87abe&#x27;</span>, &#123; <span class="attr">responseType</span>: <span class="string">&#x27;json&#x27;</span> &#125;)</span><br><span class="line">  <span class="keyword">return</span> response.body</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写完成后在该云函数目录右键开启云函数本地调试。</p>
<p>这段代码中我们通过<a target="_blank" rel="noopener" href="https://github.com/sindresorhus/got#readme">got</a>发送一个get请求到上述的API地址中，再将获取到的Response中的body返回给小程序客户端。</p>
<h2 id="小程序调用云函数"><a href="#小程序调用云函数" class="headerlink" title="小程序调用云函数"></a>小程序调用云函数</h2><p>在小程序中我们使用如下代码来调用云函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx.cloud.callFunction(&#123; <span class="attr">name</span>:<span class="string">&quot;getGhibliFilm&quot;</span>&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;  </span><br><span class="line">      <span class="built_in">console</span>.log(res);</span><br><span class="line">    &#125;).catch(<span class="built_in">console</span>.error)</span><br></pre></td></tr></table></figure>

<p>运行小程序，如果你在控制台看到下方的返回，说明你的云函数调用成功了。稍后你可以关闭云函数本地调试，上传并部署该云函数。</p>
<p><img src="https://i.loli.net/2020/11/21/d5tc3HTr1WbXG9f.png" alt="2020-11-21_云函数返回结果.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>垃圾微信，生态搞得这么封闭又臃肿，不想再搞微信小程序了。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021744516">小程序如何访问未备案的 API ｜ 云开发</a></p>
</p></div><div class="share"><span>分享到</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a target="_blank" rel="noopener" href="http://twitter.com/home?status=http://mightyherox.me/如何使用云函数绕过微信小程序网络通信的域名限制/%20circlehotarux's blog%20如何使用云函数绕过微信小程序网络通信的域名限制" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/%E6%9D%80%E6%AD%BB%E9%82%A3%E4%B8%AAMySQL-main-process-exited-code-killed-status-9-kill/" title="杀死那个MySQL-main process exited code=killed status=9/kill"><i class="fa fa-angle-double-left"></i>&nbsp;上一篇: 杀死那个MySQL-main process exited code=killed status=9/kill</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/github%E9%95%9C%E5%83%8F%E7%AB%99/" title="github镜像站">下一篇: github镜像站&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'circlehotarux-blog';
var disqus_identifier = '如何使用云函数绕过微信小程序网络通信的域名限制/';
var disqus_title = '如何使用云函数绕过微信小程序网络通信的域名限制';
var disqus_url = 'http://mightyherox.me/如何使用云函数绕过微信小程序网络通信的域名限制/';
(function () {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//circlehotarux-blog.disqus.com/count.js" async></script></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2021&nbsp;<a target="_blank" href="http://mightyherox.me" rel="noopener noreferrer">circlehotarux</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>